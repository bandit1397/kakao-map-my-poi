<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>카카오맵 위치 저장 — LocalStorage + Polyline + 편집/삭제 + CSV/JSON</title>
<link rel="icon" href="data:,">

<style>
:root { --border:#dcdcdc; }
body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin: 16px; }
h1 { font-size: 20px; margin: 0 0 10px; }
.toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 12px; }
button { padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; cursor: pointer; }
button:hover { background:#f6f6f6; }
#map { width: 100%; height: 420px; border: 1px solid var(--border); border-radius: 12px; }
.panel { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
.list { border:1px solid var(--border); border-radius: 12px; padding: 8px; max-height: 260px; overflow: auto; }
.row { display:flex; align-items: center; gap:6px; padding:6px; border-bottom:1px dashed #eee; }
.row:last-child { border-bottom: none; }
.row .meta { flex: 1; min-width: 0; }
.row .meta .title { font-weight: 600; font-size: 13px; }
.row .meta .sub { color:#666; font-size: 12px; }
.pill { padding:2px 6px; background:#f2f2f2; border-radius: 999px; font-size: 11px; }
.danger { color:#b00020; }
.foot { font-size:12px; color:#666; margin-top:8px; }
</style>
</head>
<body>
<h1>카카오맵 위치 저장 — LocalStorage + Polyline + 편집/삭제 + CSV/JSON</h1>

<div id="map"></div>

<div class="toolbar">
    <button id="btnSave">📍 내 위치 저장</button>
    <button id="btnCenter">🎯 현재 위치로 이동</button>
    <button id="btnCsv">⬇️ CSV 다운로드</button>
    <button id="btnJson">⬇️ JSON 다운로드</button>
    <span class="pill" id="countPill">총 0개</span>
</div>

<div class="panel">
    <div class="list" id="list"></div>
    <div class="foot">💡 팁: 마커를 <b>클릭</b>하면 해당 포인트의 <b>이름 편집</b> 또는 <span class="danger"><b>삭제</b></span>가 가능합니다.</div>
</div>

<!-- ✅ 카카오맵 SDK 동적 로드 (캐시 방지) -->
<script>
(function() {
    const script = document.createElement('script');
    script.src = "https://dapi.kakao.com/v2/maps/sdk.js?appkey=91d4176cb6da4e212c947c5d549ac640&autoload=false&libraries=services,drawing&v=" + Date.now();
    script.defer = true;
    document.head.appendChild(script);

    script.onload = function() {
        kakao.maps.load(initMap);
    };

    function initMap() {
        const container = document.getElementById('map');
        const options = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 5 };
        const map = new kakao.maps.Map(container, options);

        const markers = [];
        const polyline = new kakao.maps.Polyline({
            path: [],
            strokeWeight: 3,
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
        });
        polyline.setMap(map);

        const listEl = document.getElementById('list');
        const countPill = document.getElementById('countPill');

        let points = JSON.parse(localStorage.getItem('savedPoints') || '[]');
        renderList();

        function renderList() {
            listEl.innerHTML = '';
            markers.forEach(m => m.setMap(null));
            markers.length = 0;
            const path = [];

            points.forEach((p, idx) => {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(p.lat, p.lng),
                    map: map
                });
                markers.push(marker);
                path.push(new kakao.maps.LatLng(p.lat, p.lng));

                kakao.maps.event.addListener(marker, 'click', function() {
                    const newName = prompt('이름 수정 또는 삭제 (공백입력시 삭제):', p.name);
                    if (newName === null) return;
                    if (newName.trim() === '') {
                        points.splice(idx, 1);
                    } else {
                        points[idx].name = newName;
                    }
                    savePoints();
                    renderList();
                });

                const row = document.createElement('div');
                row.className = 'row';
                row.innerHTML = `<div class="meta"><div class="title">${p.name}</div><div class="sub">${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div></div>`;
                listEl.appendChild(row);
            });

            polyline.setPath(path);
            countPill.textContent = `총 ${points.length}개`;
            savePoints();
        }

        function savePoints() {
            localStorage.setItem('savedPoints', JSON.stringify(points));
        }

        document.getElementById('btnSave').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const name = prompt('이 위치의 이름을 입력하세요:', `위치 ${points.length + 1}`);
                    if (!name) return;
                    points.push({ name, lat, lng });
                    savePoints();
                    renderList();
                });
            } else {
                alert('이 브라우저는 위치 기능을 지원하지 않습니다.');
            }
        });

        document.getElementById('btnCenter').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    map.setCenter(new kakao.maps.LatLng(lat, lng));
                });
            }
        });

        document.getElementById('btnCsv').addEventListener('click', function() {
            const csv = '이름,위도,경도\n' + points.map(p => `${p.name},${p.lat},${p.lng}`).join('\n');
            downloadFile('points.csv', csv);
        });

        document.getElementById('btnJson').addEventListener('click', function() {
            const json = JSON.stringify(points, null, 2);
            downloadFile('points.json', json);
        });

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }
    }
})();
</script>
</body>
</html>
