<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¹´ì¹´ì˜¤ë§µ ìœ„ì¹˜ ì €ì¥ â€” GitHub Pagesìš©</title>

  <!-- âš ï¸ ì—¬ê¸°ë¥¼ JavaScript í‚¤ë¡œ êµì²´í•˜ì„¸ìš”. ì ˆëŒ€ ì¤„ë°”ê¿ˆ/ê³µë°± ë„£ì§€ ë§ˆì„¸ìš” -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=91d4176cb6da4e212c947c5d549ac640&autoload=false"></script>

  <style>
    :root { --border:#dcdcdc; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 12px; }
    button, input[type="text"] { padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; cursor: pointer; }
    button:hover { background:#f6f6f6; }
    #map { width: 100%; height: 420px; border: 1px solid var(--border); border-radius: 12px; }
    .panel { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    .list { border:1px solid var(--border); border-radius: 12px; padding: 8px; max-height: 260px; overflow: auto; }
    .row { display:flex; align-items: center; gap:6px; padding:6px; border-bottom:1px dashed #eee; }
    .row:last-child { border-bottom: none; }
    .row .meta { flex: 1; min-width: 0; }
    .row .meta .title { font-weight: 600; font-size: 13px; }
    .row .meta .sub { color:#666; font-size: 12px; }
    .pill { padding:2px 6px; background:#f2f2f2; border-radius: 999px; font-size: 11px; }
    .muted { color:#666; }
    .danger { color:#b00020; }
    .inline { display:inline-flex; gap:6px; align-items: center; }
    .foot { font-size:12px; color:#666; margin-top:8px; }
  </style>
</head>
<body>
  <h1>ì¹´ì¹´ì˜¤ë§µ ìœ„ì¹˜ ì €ì¥ â€” GitHub Pagesìš©</h1>

  <div id="map"></div>

  <div class="toolbar">
    <button id="btnSave">ğŸ“ ë‚´ ìœ„ì¹˜ ì €ì¥</button>
    <button id="btnCenter">ğŸ¯ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™</button>
    <button id="btnCsv">â¬‡ï¸ CSV ë‹¤ìš´ë¡œë“œ</button>
    <button id="btnJson">â¬‡ï¸ JSON ë‹¤ìš´ë¡œë“œ</button>
    <button id="btnClear">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
    <span class="pill" id="countPill">ì´ 0ê°œ</span>
  </div>

  <div class="panel">
    <div class="list" id="list"></div>
    <div class="foot">íŒ: ë§ˆì»¤ í´ë¦­ ì‹œ ì´ë¦„ ë³€ê²½ ë˜ëŠ” ì‚­ì œ. ë¦¬ìŠ¤íŠ¸ì—ì„œë„ ì§€ë„ì´ë™/ì´ë¦„/ì‚­ì œ ê°€ëŠ¥.</div>
  </div>

  <script>
    // ---------- ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤ ----------
    const LS_POSITIONS_KEY = 'km_positions_v1';
    const LS_NEXT_ID_KEY = 'km_next_id_v1';

    // ---------- ìƒíƒœ ----------
    let map, polyline;
    let markers = new Map(); // id -> kakao.maps.Marker
    let positions = [];      // {id, lat, lon, name, ts}
    let nextId = 1;

    // ---------- ìœ í‹¸ ----------
    const fmt = n => Number(n).toFixed(6);
    const tsToStr = ts => new Date(ts).toLocaleString();
    function saveState(){
      localStorage.setItem(LS_POSITIONS_KEY, JSON.stringify(positions));
      localStorage.setItem(LS_NEXT_ID_KEY, String(nextId));
      updateCount();
    }
    function loadState(){
      positions = JSON.parse(localStorage.getItem(LS_POSITIONS_KEY) || '[]');
      const savedNext = parseInt(localStorage.getItem(LS_NEXT_ID_KEY) || '0', 10);
      if (Number.isFinite(savedNext) && savedNext > 0) nextId = savedNext;
      else nextId = positions.length ? Math.max(...positions.map(p=>p.id)) + 1 : 1;
      updateCount();
    }
    function updateCount(){
      document.getElementById('countPill').textContent = `ì´ ${positions.length}ê°œ`;
    }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

    // ---------- ì§€ë„ ì´ˆê¸°í™” ì½œë°± (kakao.maps.load ì´í›„ í˜¸ì¶œ) ----------
    function initMap(){
      const container = document.getElementById('map');
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      map = new kakao.maps.Map(container, { center, level: 3 });

      loadState();
      positions.forEach(addMarker);
      redrawPolyline();
      renderList();
      centerToCurrent(false);
    }

    // ---------- í˜„ì¬ ìœ„ì¹˜ë¡œ ì„¼í„° ì´ë™ ----------
    function centerToCurrent(alertOnFail=true){
      if (!navigator.geolocation){ if (alertOnFail) alert('GPS ë¯¸ì§€ì›'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        map.setCenter(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
      }, () => { if (alertOnFail) alert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.'); });
    }

    // ---------- ì €ì¥ ----------
    function saveMyLocation(){
      if (!navigator.geolocation){ alert('GPS ë¯¸ì§€ì›'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        const point = { id: nextId++, lat, lon, name: 'ë©”ëª¨ ì—†ìŒ', ts: Date.now() };
        positions.push(point);
        addMarker(point);
        redrawPolyline();
        renderList();
        saveState();
      }, () => { alert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); });
    }

    // ---------- ë§ˆì»¤ ì¶”ê°€ ----------
    function addMarker(point){
      const marker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(point.lat, point.lon) });
      marker.setMap(map);

      kakao.maps.event.addListener(marker, 'click', function(){
        const action = prompt(`ID: ${point.id}\nì¢Œí‘œ: ${fmt(point.lat)}, ${fmt(point.lon)}\ní˜„ì¬ ë©”ëª¨: ${point.name}\n\në©”ëª¨ ë³€ê²½: ìƒˆ í…ìŠ¤íŠ¸ ì…ë ¥\nì‚­ì œ: ì •í™•íˆ "ì‚­ì œ" ì…ë ¥`);
        if (action === null) return;
        if (action.trim() === 'ì‚­ì œ') removePoint(point.id);
        else if (action.trim() !== '') renamePoint(point.id, action.trim());
      });

      markers.set(point.id, marker);
    }

    // ---------- í´ë¦¬ë¼ì¸ ----------
    function redrawPolyline(){
      if (polyline) polyline.setMap(null);
      const path = positions.map(p => new kakao.maps.LatLng(p.lat, p.lon));
      polyline = new kakao.maps.Polyline({
        path, strokeWeight: 4, strokeColor: '#FF0000', strokeOpacity: 0.85, strokeStyle: 'solid'
      });
      polyline.setMap(map);
    }

    // ---------- ë¦¬ìŠ¤íŠ¸ ë Œë” ----------
    function renderList(){
      const el = document.getElementById('list'); el.innerHTML = '';
      positions.forEach(p => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
          <div class="meta">
            <div class="title">#${p.id} â€” <span class="muted">${fmt(p.lat)}, ${fmt(p.lon)}</span></div>
            <div class="sub">ì´ë¦„: <b>${escapeHtml(p.name)}</b> Â· ì €ì¥: ${tsToStr(p.ts)}</div>
          </div>
          <div class="inline">
            <button data-act="go" data-id="${p.id}">ì§€ë„ì´ë™</button>
            <button data-act="name" data-id="${p.id}">ì´ë¦„</button>
            <button data-act="del" data-id="${p.id}" class="danger">ì‚­ì œ</button>
          </div>`;
        el.appendChild(div);
      });
      el.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = Number(e.currentTarget.getAttribute('data-id'));
          const act = e.currentTarget.getAttribute('data-act');
          if (act === 'go') panToPoint(id);
          else if (act === 'name') renamePoint(id);
          else if (act === 'del') removePoint(id);
        });
      });
    }

    // ---------- ì´ë¦„ ë³€ê²½ ----------
    function renamePoint(id, newName){
      const idx = positions.findIndex(p => p.id === id); if (idx < 0) return;
      let name = newName;
      if (!name){
        name = prompt('ìƒˆ ì´ë¦„ ì…ë ¥:', positions[idx].name || ''); if (name === null) return; name = name.trim();
      }
      if (name === '') return;
      positions[idx].name = name; saveState(); renderList();
    }

    // ---------- ì‚­ì œ ----------
    function removePoint(id){
      const idx = positions.findIndex(p => p.id === id); if (idx < 0) return;
      positions.splice(idx,1);
      const mk = markers.get(id); if (mk){ mk.setMap(null); markers.delete(id); }
      redrawPolyline(); renderList(); saveState();
    }

    // ---------- ì „ì²´ì‚­ì œ ----------
    function clearAll(){
      if (!confirm('ëª¨ë“  ì €ì¥ ìœ„ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      positions = []; nextId = 1;
      markers.forEach(m => m.setMap(null)); markers.clear();
      if (polyline) polyline.setMap(null);
      renderList(); saveState();
      localStorage.removeItem(LS_POSITIONS_KEY); localStorage.removeItem(LS_NEXT_ID_KEY);
    }

    // ---------- ì§€ë„ ì´ë™ ----------
    function panToPoint(id){
      const p = positions.find(x => x.id === id); if (!p) return;
      map.panTo(new kakao.maps.LatLng(p.lat, p.lon));
    }

    // ---------- CSV / JSON ë‹¤ìš´ë¡œë“œ ----------
    function downloadCSV(){
      const header = 'ID,Name,Latitude,Longitude,Timestamp\n';
      const rows = positions.map(p => `${p.id},"${(p.name||'').replaceAll('"','""')}",${p.lat},${p.lon},${new Date(p.ts).toISOString()}`);
      const csv = header + rows.join('\n'); downloadBlob(csv,'text/csv;charset=utf-8;','locations.csv');
    }
    function downloadJSON(){ downloadBlob(JSON.stringify(positions,null,2),'application/json;charset=utf-8;','locations.json'); }
    function downloadBlob(content,type,filename){
      const blob = new Blob([content],{type}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // ---------- ë²„íŠ¼ ë°”ì¸ë”© ----------
    document.getElementById('btnSave').addEventListener('click', saveMyLocation);
    document.getElementById('btnCenter').addEventListener('click', () => centerToCurrent(true));
    document.getElementById('btnCsv').addEventListener('click', downloadCSV);
    document.getElementById('btnJson').addEventListener('click', downloadJSON);
    document.getElementById('btnClear').addEventListener('click', clearAll);

    // ---------- SDK ë¡œë“œ í›„ init ----------
    if (window.kakao && kakao.maps) {
      kakao.maps.load(initMap);
    } else {
      // SDKê°€ ë¹„ë™ê¸° ë¡œë“œë˜ì—ˆì„ ë•Œ ëŒ€ë¹„
      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (window.kakao && kakao.maps) {
          clearInterval(t); kakao.maps.load(initMap);
        } else if (tries > 20) {
          clearInterval(t);
          alert('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì‹¤íŒ¨: appkeyë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
      }, 200);
    }
  </script>
</body>
</html>
