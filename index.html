<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>카카오맵 위치 저장 — GitHub Pages용</title>

  <!-- ⚠️ 여기를 JavaScript 키로 교체하세요. 절대 줄바꿈/공백 넣지 마세요 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=91d4176cb6da4e212c947c5d549ac640&autoload=false"></script>

  <style>
    :root { --border:#dcdcdc; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 12px; }
    button, input[type="text"] { padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; cursor: pointer; }
    button:hover { background:#f6f6f6; }
    #map { width: 100%; height: 420px; border: 1px solid var(--border); border-radius: 12px; }
    .panel { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    .list { border:1px solid var(--border); border-radius: 12px; padding: 8px; max-height: 260px; overflow: auto; }
    .row { display:flex; align-items: center; gap:6px; padding:6px; border-bottom:1px dashed #eee; }
    .row:last-child { border-bottom: none; }
    .row .meta { flex: 1; min-width: 0; }
    .row .meta .title { font-weight: 600; font-size: 13px; }
    .row .meta .sub { color:#666; font-size: 12px; }
    .pill { padding:2px 6px; background:#f2f2f2; border-radius: 999px; font-size: 11px; }
    .muted { color:#666; }
    .danger { color:#b00020; }
    .inline { display:inline-flex; gap:6px; align-items: center; }
    .foot { font-size:12px; color:#666; margin-top:8px; }
  </style>
</head>
<body>
  <h1>카카오맵 위치 저장 — GitHub Pages용</h1>

  <div id="map"></div>

  <div class="toolbar">
    <button id="btnSave">📍 내 위치 저장</button>
    <button id="btnCenter">🎯 현재 위치로 이동</button>
    <button id="btnCsv">⬇️ CSV 다운로드</button>
    <button id="btnJson">⬇️ JSON 다운로드</button>
    <button id="btnClear">🗑️ 전체 삭제</button>
    <span class="pill" id="countPill">총 0개</span>
  </div>

  <div class="panel">
    <div class="list" id="list"></div>
    <div class="foot">팁: 마커 클릭 시 이름 변경 또는 삭제. 리스트에서도 지도이동/이름/삭제 가능.</div>
  </div>

  <script>
    // ---------- 로컬스토리지 키 ----------
    const LS_POSITIONS_KEY = 'km_positions_v1';
    const LS_NEXT_ID_KEY = 'km_next_id_v1';

    // ---------- 상태 ----------
    let map, polyline;
    let markers = new Map(); // id -> kakao.maps.Marker
    let positions = [];      // {id, lat, lon, name, ts}
    let nextId = 1;

    // ---------- 유틸 ----------
    const fmt = n => Number(n).toFixed(6);
    const tsToStr = ts => new Date(ts).toLocaleString();
    function saveState(){
      localStorage.setItem(LS_POSITIONS_KEY, JSON.stringify(positions));
      localStorage.setItem(LS_NEXT_ID_KEY, String(nextId));
      updateCount();
    }
    function loadState(){
      positions = JSON.parse(localStorage.getItem(LS_POSITIONS_KEY) || '[]');
      const savedNext = parseInt(localStorage.getItem(LS_NEXT_ID_KEY) || '0', 10);
      if (Number.isFinite(savedNext) && savedNext > 0) nextId = savedNext;
      else nextId = positions.length ? Math.max(...positions.map(p=>p.id)) + 1 : 1;
      updateCount();
    }
    function updateCount(){
      document.getElementById('countPill').textContent = `총 ${positions.length}개`;
    }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

    // ---------- 지도 초기화 콜백 (kakao.maps.load 이후 호출) ----------
    function initMap(){
      const container = document.getElementById('map');
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      map = new kakao.maps.Map(container, { center, level: 3 });

      loadState();
      positions.forEach(addMarker);
      redrawPolyline();
      renderList();
      centerToCurrent(false);
    }

    // ---------- 현재 위치로 센터 이동 ----------
    function centerToCurrent(alertOnFail=true){
      if (!navigator.geolocation){ if (alertOnFail) alert('GPS 미지원'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        map.setCenter(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
      }, () => { if (alertOnFail) alert('현재 위치를 가져오지 못했습니다. 위치 권한을 확인하세요.'); });
    }

    // ---------- 저장 ----------
    function saveMyLocation(){
      if (!navigator.geolocation){ alert('GPS 미지원'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        const point = { id: nextId++, lat, lon, name: '메모 없음', ts: Date.now() };
        positions.push(point);
        addMarker(point);
        redrawPolyline();
        renderList();
        saveState();
      }, () => { alert('현재 위치를 가져오지 못했습니다.'); });
    }

    // ---------- 마커 추가 ----------
    function addMarker(point){
      const marker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(point.lat, point.lon) });
      marker.setMap(map);

      kakao.maps.event.addListener(marker, 'click', function(){
        const action = prompt(`ID: ${point.id}\n좌표: ${fmt(point.lat)}, ${fmt(point.lon)}\n현재 메모: ${point.name}\n\n메모 변경: 새 텍스트 입력\n삭제: 정확히 "삭제" 입력`);
        if (action === null) return;
        if (action.trim() === '삭제') removePoint(point.id);
        else if (action.trim() !== '') renamePoint(point.id, action.trim());
      });

      markers.set(point.id, marker);
    }

    // ---------- 폴리라인 ----------
    function redrawPolyline(){
      if (polyline) polyline.setMap(null);
      const path = positions.map(p => new kakao.maps.LatLng(p.lat, p.lon));
      polyline = new kakao.maps.Polyline({
        path, strokeWeight: 4, strokeColor: '#FF0000', strokeOpacity: 0.85, strokeStyle: 'solid'
      });
      polyline.setMap(map);
    }

    // ---------- 리스트 렌더 ----------
    function renderList(){
      const el = document.getElementById('list'); el.innerHTML = '';
      positions.forEach(p => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
          <div class="meta">
            <div class="title">#${p.id} — <span class="muted">${fmt(p.lat)}, ${fmt(p.lon)}</span></div>
            <div class="sub">이름: <b>${escapeHtml(p.name)}</b> · 저장: ${tsToStr(p.ts)}</div>
          </div>
          <div class="inline">
            <button data-act="go" data-id="${p.id}">지도이동</button>
            <button data-act="name" data-id="${p.id}">이름</button>
            <button data-act="del" data-id="${p.id}" class="danger">삭제</button>
          </div>`;
        el.appendChild(div);
      });
      el.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = Number(e.currentTarget.getAttribute('data-id'));
          const act = e.currentTarget.getAttribute('data-act');
          if (act === 'go') panToPoint(id);
          else if (act === 'name') renamePoint(id);
          else if (act === 'del') removePoint(id);
        });
      });
    }

    // ---------- 이름 변경 ----------
    function renamePoint(id, newName){
      const idx = positions.findIndex(p => p.id === id); if (idx < 0) return;
      let name = newName;
      if (!name){
        name = prompt('새 이름 입력:', positions[idx].name || ''); if (name === null) return; name = name.trim();
      }
      if (name === '') return;
      positions[idx].name = name; saveState(); renderList();
    }

    // ---------- 삭제 ----------
    function removePoint(id){
      const idx = positions.findIndex(p => p.id === id); if (idx < 0) return;
      positions.splice(idx,1);
      const mk = markers.get(id); if (mk){ mk.setMap(null); markers.delete(id); }
      redrawPolyline(); renderList(); saveState();
    }

    // ---------- 전체삭제 ----------
    function clearAll(){
      if (!confirm('모든 저장 위치를 삭제하시겠습니까?')) return;
      positions = []; nextId = 1;
      markers.forEach(m => m.setMap(null)); markers.clear();
      if (polyline) polyline.setMap(null);
      renderList(); saveState();
      localStorage.removeItem(LS_POSITIONS_KEY); localStorage.removeItem(LS_NEXT_ID_KEY);
    }

    // ---------- 지도 이동 ----------
    function panToPoint(id){
      const p = positions.find(x => x.id === id); if (!p) return;
      map.panTo(new kakao.maps.LatLng(p.lat, p.lon));
    }

    // ---------- CSV / JSON 다운로드 ----------
    function downloadCSV(){
      const header = 'ID,Name,Latitude,Longitude,Timestamp\n';
      const rows = positions.map(p => `${p.id},"${(p.name||'').replaceAll('"','""')}",${p.lat},${p.lon},${new Date(p.ts).toISOString()}`);
      const csv = header + rows.join('\n'); downloadBlob(csv,'text/csv;charset=utf-8;','locations.csv');
    }
    function downloadJSON(){ downloadBlob(JSON.stringify(positions,null,2),'application/json;charset=utf-8;','locations.json'); }
    function downloadBlob(content,type,filename){
      const blob = new Blob([content],{type}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // ---------- 버튼 바인딩 ----------
    document.getElementById('btnSave').addEventListener('click', saveMyLocation);
    document.getElementById('btnCenter').addEventListener('click', () => centerToCurrent(true));
    document.getElementById('btnCsv').addEventListener('click', downloadCSV);
    document.getElementById('btnJson').addEventListener('click', downloadJSON);
    document.getElementById('btnClear').addEventListener('click', clearAll);

    // ---------- SDK 로드 후 init ----------
    if (window.kakao && kakao.maps) {
      kakao.maps.load(initMap);
    } else {
      // SDK가 비동기 로드되었을 때 대비
      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (window.kakao && kakao.maps) {
          clearInterval(t); kakao.maps.load(initMap);
        } else if (tries > 20) {
          clearInterval(t);
          alert('카카오맵 SDK 로드 실패: appkey를 확인하세요.');
        }
      }, 200);
    }
  </script>
</body>
</html>
